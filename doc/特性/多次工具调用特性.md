# 多次工具调用特性

## 需求背景

当前 SelfTool 流程是单次执行模式：分析 → 检索/生成 → 执行 → 结束。

对于复杂任务（如多步数学计算、需要多次查询的问题），需要支持 LLM 自主决定是否继续调用工具。

## 目标

引入 ReAct Agent 模式，支持 `LLM决策 → 工具执行 → LLM决策 → ...` 的循环结构。

## 设计方案

### 当前流程

```
START → analyze → plan_tasks → prepare_task → search → generate/use_existing 
      → safety_check → execute → register → save_result → aggregate → format_response → END
```

### 改造后流程

在 `format_response` 后增加条件判断，让 LLM 决定是否需要继续执行：

```
... → format_response → should_continue_check
                              ↓
                    需要继续 → prepare_task (循环回去)
                    完成 → END
```

### 核心改动

#### 1. 修改 `state.py`
新增状态字段：
- `iteration_count`: 当前迭代次数
- `max_iterations`: 最大迭代次数（防止无限循环）
- `continue_reasoning`: LLM 判断是否继续的理由

#### 2. 新增节点 `should_continue_node`
- 调用 LLM 判断当前结果是否完整
- 如果任务未完成且未达到最大迭代次数，返回 `continue`
- 否则返回 `end`

#### 3. 修改 `graph.py`
- 在 `format_response` 后添加 `should_continue` 节点
- 添加条件边：
  - `continue` → `prepare_task`
  - `end` → `END`

#### 4. 修改 `routing.py`
- 新增 `route_after_format` 路由函数

## 执行步骤

### 步骤1: 修改 state.py [已完成]
- [x] 添加 `iteration_count` 字段
- [x] 添加 `max_iterations` 字段（默认 5）
- [x] 添加 `continue_reasoning` 字段

### 步骤2: 修改 nodes.py [已完成]
- [x] 新增 `should_continue_node` 节点函数

### 步骤3: 修改 routing.py [已完成]
- [x] 新增 `route_after_should_continue` 函数

### 步骤4: 修改 graph.py [已完成]
- [x] 添加 `should_continue` 节点
- [x] 修改 `format_response` -> `should_continue` 边
- [x] 添加条件边：`continue` -> `search`, `end` -> `END`

### 步骤5: 测试验证
- [ ] 测试简单任务（单次执行）
- [ ] 测试复杂任务（多步计算）
- [ ] 验证最大迭代限制

## 安全考虑

1. **最大迭代限制**：防止 LLM 陷入无限循环
2. **迭代计数**：每次循环递增，达到上限强制结束
3. **成本控制**：每次迭代都会调用 LLM，需控制最大次数

## 示例场景

**输入**: "计算 (15 + 27) * 3 - 12 / 4 的结果"

**执行过程**:
1. 第1次迭代：生成加法工具，计算 15 + 27 = 42
2. 第2次迭代：生成乘法工具，计算 42 * 3 = 126
3. 第3次迭代：生成除法工具，计算 12 / 4 = 3
4. 第4次迭代：生成减法工具，计算 126 - 3 = 123
5. LLM 判断任务完成，返回最终结果
